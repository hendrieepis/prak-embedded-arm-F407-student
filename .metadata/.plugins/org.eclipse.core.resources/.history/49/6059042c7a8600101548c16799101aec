#include "main.h"
#include "usb_device.h"
#include <stdio.h>
#include "hardwareinit.h"
#include "counter.h"
#include "sensor.h"



extern USBD_HandleTypeDef hUsbDeviceFS;  // deklarasi handle dari usb_device.c
static inline uint8_t usb_is_configured(void){
	return (hUsbDeviceFS.dev_state == USBD_STATE_CONFIGURED);
}

extern uint8_t CDC_Transmit_FS(uint8_t* Buf, uint16_t Len);

int _write(int file, char *ptr, int len) {
	CDC_Transmit_FS((uint8_t*) ptr, len); return len;
}





//utility.c utility.h
void checkBoard(void);



void checkBoard(void) {
	printf("Cek BarLED, buzzer, USER LED \n\r");
	HAL_Delay(300);
	for (uint8_t cnt=0;cnt<8;cnt++){

		HAL_GPIO_TogglePin(BAR0_GPIO_Port, BAR0_Pin);
		HAL_GPIO_TogglePin(BAR1_GPIO_Port, BAR1_Pin);
		HAL_GPIO_TogglePin(BAR2_GPIO_Port, BAR2_Pin);
		HAL_GPIO_TogglePin(BAR3_GPIO_Port, BAR3_Pin);
		HAL_GPIO_TogglePin(BAR4_GPIO_Port, BAR4_Pin);
		HAL_GPIO_TogglePin(BAR5_GPIO_Port, BAR5_Pin);
		HAL_GPIO_TogglePin(BAR6_GPIO_Port, BAR6_Pin);
		HAL_GPIO_TogglePin(BAR7_GPIO_Port, BAR7_Pin);

		HAL_GPIO_TogglePin(BUZZER_GPIO_Port, BUZZER_Pin);
		HAL_GPIO_TogglePin(LD3_GPIO_Port, LD3_Pin);
		HAL_GPIO_TogglePin(LD4_GPIO_Port, LD4_Pin);
		HAL_GPIO_TogglePin(LD5_GPIO_Port, LD5_Pin);
		HAL_GPIO_TogglePin(LD6_GPIO_Port, LD6_Pin);
		printf("count: %d \n\r",cnt);
		HAL_Delay(100);
	}

}
/* USER CODE END 0 */

/**
 * @brief  The application entry point.
 * @retval int
 */
int main(void)
{


	HAL_Init();


	SystemClock_Config();


	MX_GPIO_Init();
	MX_I2C1_Init();
	MX_I2S3_Init();
	MX_SPI1_Init();
	MX_USB_DEVICE_Init();
	uint32_t t0 = HAL_GetTick();
	while (!usb_is_configured() && (HAL_GetTick() - t0) < 2000) {
		HAL_Delay(10);
	}
	HAL_Delay(700); //fix auto connect serial app
	checkBoard();

	while (1)
	{

		if(sensorDetected()){
			counterUpdate();
			printf("nilai counter: %d \n\r",counterShow());
		}

		if(resetDetected()){
			counterZero();
			printf("nilai counter: %d \n\r",counterShow());
		}


	}
}



