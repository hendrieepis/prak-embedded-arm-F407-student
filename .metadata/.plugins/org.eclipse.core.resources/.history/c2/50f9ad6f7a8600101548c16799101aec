#include "main.h"
#include "usb_device.h"
#include <stdio.h>
#include "hardwareinit.h"
#include "counter.h"
#include "sensor.h"
#include "utility.h"

extern USBD_HandleTypeDef hUsbDeviceFS;  // deklarasi handle dari usb_device.c
static inline uint8_t usb_is_configured(void){
	return (hUsbDeviceFS.dev_state == USBD_STATE_CONFIGURED);
}

extern uint8_t CDC_Transmit_FS(uint8_t* Buf, uint16_t Len);

int _write(int file, char *ptr, int len) {
	CDC_Transmit_FS((uint8_t*) ptr, len); return len;
}


int main(void)
{


	HAL_Init();


	SystemClock_Config();


	MX_GPIO_Init();
	MX_I2C1_Init();
	MX_I2S3_Init();
	MX_SPI1_Init();
	MX_USB_DEVICE_Init();
	uint32_t t0 = HAL_GetTick();
	while (!usb_is_configured() && (HAL_GetTick() - t0) < 2000) {
		HAL_Delay(10);
	}
	HAL_Delay(700); //fix auto connect serial app
	checkBoard();

	while (1)
	{

		if(sensorDetected()){
			counterUpdate();
			printf("nilai counter: %d \n\r",counterShow());
		}

		if(resetDetected()){
			counterZero();
			printf("nilai counter: %d \n\r",counterShow());
		}


	}
}



